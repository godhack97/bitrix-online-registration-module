# Описание модуля записи на услуги

## 1. Шаги оформления записи

### Выбор услуги
- Пользователь выбирает услугу из списка доступных услуг для данной сущности.
- Услуги могут быть отсортированы по категориям или специализации (если применимо).

### Выбор мастера (опционально)
- Если администратор включил опцию "выбор мастера", пользователь выбирает мастера из списка.
- Если опция отключена, этот шаг пропускается.

### Выбор времени
- Отображение доступных слотов времени на основе графика работы и текущих записей.
- Если выбран мастер, время фильтруется по его расписанию.

### Заполнение контактов
- Пользователь заполняет обязательные поля (имя, телефон, email).
- Администратор может настроить, какие поля являются обязательными.

### Оплата (опционально)
- Если включена опция оплаты, пользователь переходит на страницу оплаты.

### Подтверждение записи
- После отправки формы пользователь получает подтверждение записи (email, SMS).
- Администратор также получает уведомление о новой записи.

---

## 2. Корректировка административной части

Поскольку выбор сущности не требуется, административная часть упрощается:

### Настройка сущности
- Администратор создает одну сущность (например, "Парикмахерская") и настраивает её параметры.
- Все услуги, сотрудники и график работы привязаны к этой сущности.

### Управление услугами
- Услуги создаются и редактируются для конкретной сущности.
- Возможность группировки услуг по категориям (например, "Стрижки", "Окрашивание").

### Управление сотрудниками
- Сотрудники добавляются и привязываются к сущности.
- Настройка графика работы для каждого сотрудника.

### Настройка формы записи
- Включение/выключение опции "выбор мастера".
- Настройка обязательных полей для контактов пользователя.

---

## 3. Архитектура модуля

Архитектура остается практически без изменений, но таблица `entities` содержит только одну запись для каждой установки модуля.

### База данных

#### Таблицы:
- `entities` – хранение информации о сущности (одна запись для парикмахерской, автосервиса и т.д.).
- `services` – список услуг для сущности.
- `employees` – информация о сотрудниках.
- `schedule` – график работы сотрудников.
- `bookings` – записи пользователей.

#### Структура таблиц:
```sql
CREATE TABLE entities (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255),
    description TEXT,
    allow_master_selection TINYINT(1) DEFAULT 0 -- 1 = включено, 0 = выключено
);

CREATE TABLE services (
    id INT AUTO_INCREMENT PRIMARY KEY,
    entity_id INT,
    category VARCHAR(255), -- Категория услуги (опционально)
    name VARCHAR(255),
    duration INT, -- в минутах
    price DECIMAL(10, 2)
);

CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    entity_id INT,
    name VARCHAR(255),
    specialization VARCHAR(255)
);

CREATE TABLE schedule (
    id INT AUTO_INCREMENT PRIMARY KEY,
    employee_id INT,
    day_of_week INT, -- 1 = понедельник, ..., 7 = воскресенье
    start_time TIME,
    end_time TIME
);

CREATE TABLE bookings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    service_id INT,
    employee_id INT NULL, -- NULL, если выбор мастера отключен
    user_name VARCHAR(255),
    user_phone VARCHAR(20),
    user_email VARCHAR(255),
    booking_date DATETIME,
    status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending'
);

## 4. Интерфейс пользователя

### Форма записи

#### Выбор услуги
- Отображение списка услуг с возможностью фильтрации по категориям.
- Каждая услуга содержит информацию о длительности и цене.

#### Выбор мастера (опционально)
- Если включена опция "выбор мастера", отображается список мастеров с их специализацией.

#### Выбор времени
- Отображение доступных слотов времени в виде календаря или списка.
- Если выбран мастер, время фильтруется по его расписанию.

#### Заполнение контактов
- Простая форма с полями для имени, телефона и email.

#### Оплата (опционально)
- Интеграция с платежными системами (например, Яндекс.Касса, PayPal).

#### Подтверждение записи
- После отправки формы пользователь видит сообщение об успешной записи.
- Отправка уведомлений (email, SMS).

---

## 5. API

API работает только для одной сущности:
- `GET /api/services` – получение списка услуг.
- `GET /api/available-slots?date=Y&employee_id=Z` – получение доступных слотов времени.
- `POST /api/bookings` – создание новой записи.

---

## 6. Технические решения

### Язык программирования
- **PHP** для бэкенда (использование стандартных механизмов Битрикс).
- **JavaScript** (Vue.js или React) для фронтенда.

### Использование Битрикс API
- Использование `CIBlock`, `CUser` и других механизмов для работы с базой данных.
- Интеграция с событиями Битрикс для отправки уведомлений.

### Кэширование
- Кэширование доступных слотов времени для снижения нагрузки на сервер.

### Безопасность
- Валидация всех входящих данных.
- Защита от SQL-инъекций и XSS-атак.

---

## 7. Этапы разработки

### Проектирование
- Создание ER-диаграммы базы данных.
- Разработка макетов административной панели и формы записи.

### Разработка
- Реализация административной части.
- Создание API для фронтенда.
- Разработка пользовательской части.

### Тестирование
- Тестирование функционала на различных устройствах.
- Проверка производительности при средней нагрузке.

### Документация
- Подготовка инструкции для администраторов сайтов.
- Описание API для разработчиков.

---

## 8. Возможные дополнения

- **Интеграция с CRM**: Автоматическая передача записей в CRM-систему.
- **Отзывы и рейтинги**: Пользователи могут оставлять отзывы о сотрудниках.
- **Мобильное приложение**: Создание мобильной версии для удобства пользователей.
